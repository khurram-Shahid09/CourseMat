{% extends "base.html" %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
/* Center text inside input and select fields */
form.mb-3 input.form-control,
form.mb-3 select.form-control {
    text-align: center;
    height: 38px;
    border-radius: 6px;
    font-size: 14px;
}

/* Select2 dropdown styling to match inputs */
.select2-container--default .select2-selection--single {
     height: 45px;
      padding: 6px 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      display: flex;
      align-items: center;
      color: #000;
}
  .select2-container--default .select2-results__option {
      color: #000;
      padding: 6px 12px;
  }
.select2-container--default .select2-selection--single .select2-selection__rendered {
    text-align: center;
    width: 100%;
}

.select2-container--default .select2-selection--single .select2-selection__placeholder {
    color: #000000;
    font-style: normal;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    right: 10px;
}
</style>
{% endblock %}

{% block content %}
<h3>Fee Management</h3>

<form method="get" class="mb-3">
  <div class="row g-2">
    <div class="col-md-3">
      <input type="text" name="search" value="{{ request.GET.search }}"
             class="form-control" placeholder="Search by Student Name/Email">
    </div>
    <div class="col-md-2">
      <select name="course" class="form-control">
        <option value="">All Courses</option>
        {% for course in courses %}
        <option value="{{ course.id }}" {% if request.GET.course == course.id|stringformat:"s" %}selected{% endif %}>
          {{ course.title }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <select name="batch" class="form-control">
        <option value="">All Batches</option>
        {% for batch in batches %}
        <option value="{{ batch.id }}" {% if request.GET.batch == batch.id|stringformat:"s" %}selected{% endif %}>
          {{ batch.name }} ({{ batch.course.title }})
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <select name="fee_type" class="form-control">
        <option value="">All Fee Types</option>
        <option value="one_time" {% if request.GET.fee_type == "one_time" %}selected{% endif %}>One-time</option>
        <option value="installment" {% if request.GET.fee_type == "installment" %}selected{% endif %}>Installment</option>
        <option value="custom" {% if request.GET.fee_type == "custom" %}selected{% endif %}>Custom</option>
      </select>
    </div>
    <div class="col-md-2">
      <select name="status" class="form-control">
        <option value="">All Status</option>
        <option value="paid" {% if request.GET.status == "paid" %}selected{% endif %}>Paid</option>
        <option value="partial" {% if request.GET.status == "partial" %}selected{% endif %}>Partially Paid</option>
        <option value="pending" {% if request.GET.status == "pending" %}selected{% endif %}>Pending</option>
      </select>
    </div>
    <div class="col-md-1">
      <button type="submit" class="btn btn-primary w-100">Filter</button>
    </div>
  </div>
</form>

<table class="table table-striped table-bordered">
  <thead>
    <tr>
      <th>#</th>
      <th>Student</th>
      <th>Course</th>
      <th>Enrollment id</th>
      <th>Fee Type</th>
      <th>Total Fee</th>
      <th>Paid Amount</th>
      <th>Pending Amount</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for enrollment in enrollments %}
    <form method="post" style="display:contents;">
      {% csrf_token %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ enrollment.student.name }}</td>
        <td>{{ enrollment.batch.course.title }} ({{ enrollment.batch.course.course_code }})</td>
        <td>{{ enrollment.roll_number }}</td>
        <td>
          <select name="fee_type" class="form-control" style="width:120px;">
            <option value="one_time" {% if enrollment.fee_type == "one_time" %}selected{% endif %}>One-time</option>
            <option value="installment" {% if enrollment.fee_type == "installment" %}selected{% endif %}>Installment</option>
            <option value="custom" {% if enrollment.fee_type == "custom" %}selected{% endif %}>Custom</option>
          </select>
        </td>

        <td>
          {% if enrollment.fee_type == 'installment' %}
            {{ enrollment.total_fee }}
          {% else %}
            {{ enrollment.fee_at_enrollment }}
          {% endif %}
        </td>

        <td>
          {% if enrollment.fee_type == 'installment' %}
            <input type="number" name="paid_amount" value="{{ enrollment.paid_amount_display }}" class="form-control" style="width:100px;">
          {% else %}
            <input type="number" name="paid_amount" value="{{ enrollment.paid_amount }}" class="form-control" style="width:100px;">
          {% endif %}
        </td>

        <td style="color: red">
          {{ enrollment.pending_amount_display }}
        </td>
        <td>
          <input type="hidden" name="enrollment_id" value="{{ enrollment.id }}">
          <button type="submit" class="btn btn-success btn-sm">Update</button>
        </td>
      </tr>
    </form>
    {% empty %}
    <tr>
      <td colspan="9" class="text-center">No enrollments found.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    $('select[name="course"], select[name="batch"]').select2({
        placeholder: 'Select an option',
        style: "color-black",
        allowClear: true,
        width: '100%'
    });
});
</script>
{% endblock %}
