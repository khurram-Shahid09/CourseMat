{% extends "base.html" %}
{% load static %}
{% block title %}Admin Analytics{% endblock %}
{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
  .select2-container .select2-selection--single {
      height: 45px;
      padding: 6px 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      display: flex;
      align-items: center;
      color: #000;
  }

  .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 100%;
      right: 10px;
  }

  .select2-container--default .select2-results__option {
      color: #000;
      padding: 6px 12px;
  }

  .select2-container--default .select2-results__option--highlighted {
      background-color: #007bff;
      color: white;
  }

  .select2-container--default .select2-selection--single .select2-selection__placeholder {
      color: #6c757d;
      font-style: italic;
  }

  /* Style search input inside dropdown */
  .select2-container--default .select2-search--dropdown .select2-search__field {
      border: 1px solid #ced4da;
      border-radius: 6px;
      padding: 6px 10px;
      width: 100%;
      font-size: 14px;
      outline: none;
      margin-bottom: 6px;
  }
</style>
{% endblock %}
{% block content %}
<div class="admin-analytics">
    <div class="page-header mb-4" style="background: linear-gradient(to right, #4f46e5, #3b82f6); color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
        <h3 class="page-title" style="font-size: 1.5rem; font-weight: bold; color: white">Analytics Dashboard</h3>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-transparent mb-0">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}" style="color: #ffffff; text-decoration: none;">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page" style="color: #ffffff;">Analytics</li>
            </ol>
        </nav>
    </div>

    <!-- Filters -->
    <form method="get" class="row mb-4 g-3 align-items-end bg-white p-4 rounded-lg shadow-sm">
       <div class="col-md-3">
    <label class="form-label" style="font-size: 0.875rem; font-weight: 500; color: #374151;">Course</label>
    <select name="course" class="form-control select2" data-placeholder="Select Course">
        <option></option> <!-- needed for placeholder -->
        <option value="">All Courses</option>
        {% for course in courses %}
            <option value="{{ course.id }}" {% if request.GET.course == course.id|stringformat:"s" %}selected{% endif %}>{{ course.title }}</option>
        {% endfor %}
    </select>
</div>

<div class="col-md-3">
    <label class="form-label" style="font-size: 0.875rem; font-weight: 500; color: #374151;">Batch</label>
    <select name="batch" class="form-control select2" data-placeholder="Select Batch">
        <option></option> <!-- needed for placeholder -->
        <option value="">All Batches</option>
        {% for batch in batches %}
            <option value="{{ batch.id }}" {% if request.GET.batch == batch.id|stringformat:"s" %}selected{% endif %}>{{ batch.batch_code }}</option>
        {% endfor %}
    </select>
</div>

        <div class="col-md-3">
            <label class="form-label" style="font-size: 0.875rem; font-weight: 500; color: #374151;">Start Date</label>
            <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="form-control">
        </div>
        <div class="col-md-3">
            <label class="form-label" style="font-size: 0.875rem; font-weight: 500; color: #374151;">End Date</label>
            <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="form-control">
        </div>
        <div class="col-md-12 text-end mt-2">
            <button type="submit" class="btn btn-primary me-2" style="background: #4f46e5; border: none;">Apply Filters</button>
            <a href="{% url 'admin_analytics' %}" class="btn btn-secondary" style="background: #6b7280; border: none;">Reset</a>
        </div>
    </form>

    <!-- Summary Cards: Row 1 -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100" style="background: linear-gradient(to bottom, #60a5fa, #3b82f6); color: white; border-radius: 0.5rem; transition: transform 0.3s, box-shadow 0.3s;">
                <div class="card-body">
                    <h6 style="font-size: 1rem; font-weight: 500; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); margin-bottom: 0.5rem;">Total Students</h6>
                    <h3 class="fw-bold" style="font-size: 2rem; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">{{ total_students|default:"0" }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100" style="background: linear-gradient(to bottom, #34d399, #10b981); color: white; border-radius: 0.5rem; transition: transform 0.3s, box-shadow 0.3s;">
                <div class="card-body">
                    <h6 style="font-size: 1rem; font-weight: 500; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); margin-bottom: 0.5rem;">Active Students</h6>
                    <h3 class="fw-bold" style="font-size: 2rem; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">{{ active_students|default:"0" }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100" style="background: linear-gradient(to bottom, #a78bfa, #8b5cf6); color: white; border-radius: 0.5rem; transition: transform 0.3s, box-shadow 0.3s;">
                <div class="card-body">
                    <h6 style="font-size: 1rem; font-weight: 500; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); margin-bottom: 0.5rem;">Total Courses</h6>
                    <h3 class="fw-bold" style="font-size: 2rem; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">{{ total_courses|default:"0" }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100" style="background: linear-gradient(to bottom, #fb923c, #f97316); color: white; border-radius: 0.5rem; transition: transform 0.3s, box-shadow 0.3s;">
                <div class="card-body">
                    <h6 style="font-size: 1rem; font-weight: 500; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); margin-bottom: 0.5rem;">Active Courses</h6>
                    <h3 class="fw-bold" style="font-size: 2rem; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">{{ active_courses|default:"0" }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards: Row 2 -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100" style="background: linear-gradient(to bottom, #f87171, #ef4444); color: white; border-radius: 0.5rem; transition: transform 0.3s, box-shadow 0.3s;">
                <div class="card-body">
                    <h6 style="font-size: 1rem; font-weight: 500; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); margin-bottom: 0.5rem;">Total Batches</h6>
                    <h3 class="fw-bold" style="font-size: 2rem; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">{{ total_batches|default:"0" }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100" style="background: linear-gradient(to bottom, #4ade80, #22c55e); color: white; border-radius: 0.5rem; transition: transform 0.3s, box-shadow 0.3s;">
                <div class="card-body">
                    <h6 style="font-size: 1rem; font-weight: 500; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); margin-bottom: 0.5rem;">Ongoing Batches</h6>
                    <h3 class="fw-bold" style="font-size: 2rem; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">{{ ongoing_batches|default:"0" }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100" style="background: linear-gradient(to bottom, #facc15, #eab308); color: white; border-radius: 0.5rem; transition: transform 0.3s, box-shadow 0.3s;">
                <div class="card-body">
                    <h6 style="font-size: 1rem; font-weight: 500; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); margin-bottom: 0.5rem;">Total Enrollments</h6>
                    <h3 class="fw-bold" style="font-size: 2rem; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">{{ total_enrollments|default:"0" }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100" style="background: linear-gradient(to bottom, #a3e635, #84cc16); color: white; border-radius: 0.5rem; transition: transform 0.3s, box-shadow 0.3s;">
                <div class="card-body">
                    <h6 style="font-size: 1rem; font-weight: 500; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); margin-bottom: 0.5rem;">Enrollments This Month</h6>
                    <h3 class="fw-bold" style="font-size: 2rem; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">{{ enrollments_this_month|default:"0" }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards: Row 3 -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100" style="background: linear-gradient(to bottom, #2dd4bf, #14b8a6); color: white; border-radius: 0.5rem; transition: transform 0.3s, box-shadow 0.3s;">
                <div class="card-body">
                    <h6 style="font-size: 1rem; font-weight: 500; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); margin-bottom: 0.5rem;">Total Fee Collected</h6>
                    <h3 class="fw-bold" style="font-size: 2rem; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">${{ total_fee_collected|default:"0" }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100" style="background: linear-gradient(to bottom, #fb7185, #f43f5e); color: white; border-radius: 0.5rem; transition: transform 0.3s, box-shadow 0.3s;">
                <div class="card-body">
                    <h6 style="font-size: 1rem; font-weight: 500; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); margin-bottom: 0.5rem;">Total Pending Fee</h6>
                    <h3 class="fw-bold" style="font-size: 2rem; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">${{ total_pending_fee|default:"0" }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100" style="background: linear-gradient(to bottom, #4ade80, #22c55e); color: white; border-radius: 0.5rem; transition: transform 0.3s, box-shadow 0.3s;">
                <div class="card-body">
                    <h6 style="font-size: 1rem; font-weight: 500; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); margin-bottom: 0.5rem;">Fee Collected This Month</h6>
                    <h3 class="fw-bold" style="font-size: 2rem; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">${{ total_fee_collected|default:"0" }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100" style="border-radius: 0.5rem;">
                <div class="card-body">
                    <h6 class="card-title mb-3" style="font-weight: 600; font-size: 1rem;">Enrollment Trends</h6>
                    {% if enrollment_chart %}
                        <canvas id="enrollmentChart"></canvas>
                    {% else %}
                        <p class="text-danger">Enrollment chart data unavailable.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm h-100" style="border-radius: 0.5rem;">
                <div class="card-body">
                    <h6 class="card-title mb-3" style="font-weight: 600; font-size: 1rem;">Fee Trends</h6>
                    {% if fee_chart %}
                        <canvas id="feeChart"></canvas>
                    {% else %}
                        <p class="text-danger">Fee chart data unavailable.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100" style="border-radius: 0.5rem;">
                <div class="card-body">
                    <h6 class="card-title mb-3" style="font-weight: 600; font-size: 1rem;">Top Courses by Enrollments</h6>
                    {% if top_courses_chart %}
                        <canvas id="topCoursesChart"></canvas>
                    {% else %}
                        <p class="text-danger">Top courses chart data unavailable.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm h-100" style="border-radius: 0.5rem;">
                <div class="card-body">
                    <h6 class="card-title mb-3" style="font-weight: 600; font-size: 1rem;">Students per Course</h6>
                    {% if students_per_course_chart %}
                        <canvas id="studentsPerCourseChart"></canvas>
                    {% else %}
                        <p class="text-danger">Students per course chart data unavailable.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Enrollments -->
    <div class="card shadow-sm border-0 mb-4" style="border-radius: 0.5rem;">
        <div class="card-body">
            <h6 class="card-title mb-3" style="font-weight: 600; font-size: 1rem;">Recent Enrollments</h6>
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="padding: 0.75rem;">Student</th>
                            <th style="padding: 0.75rem;">Course</th>
                            <th style="padding: 0.75rem;">Batch</th>
                            <th style="padding: 0.75rem;">Fee Type</th>
                            <th style="padding: 0.75rem;">Paid</th>
                            <th style="padding: 0.75rem;">Pending</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for enrollment in recent_enrollments %}
                        <tr style="transition: background 0.2s;">
                            <td style="padding: 0.75rem;">{{ enrollment.student.name }}</td>
                            <td style="padding: 0.75rem;">{{ enrollment.batch.course.title }}</td>
                            <td style="padding: 0.75rem;">{{ enrollment.batch.batch_code }}</td>
                            <td style="padding: 0.75rem;">{{ enrollment.fee_type }}</td>
                            <td style="padding: 0.75rem; color: #16a34a;">${{ enrollment.paid_amount }}</td>
                            <td style="padding: 0.75rem; color: #dc2626;">${{ enrollment.pending_amount }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center" style="padding: 1rem; color: #6b7280;">No enrollments found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Inline CSS -->
    <style>
        .admin-analytics .card {
            background: #ffffff;
            border-radius: 0.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .admin-analytics .card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            transform: scale(1.03);
        }
        .admin-analytics .card h3 {
            font-size: 2rem;
            margin: 0;
        }
        .admin-analytics .card-title {
            font-weight: 600;
            font-size: 1rem;
        }
        .admin-analytics .card-body {
            padding: 1.5rem;
        }
        .admin-analytics .form-control {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
        }
        .admin-analytics .form-control:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .admin-analytics .btn-primary:hover {
            background: #4338ca;
        }
        .admin-analytics .btn-secondary:hover {
            background: #4b5563;
        }
        .admin-analytics .table th,
        .admin-analytics .table td {
            vertical-align: middle;
        }
        .admin-analytics .table-hover tbody tr:hover {
            background: #f3f4f6;
        }
    </style>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/chart.min.js' %}"></script>
<script>
    // Enrollment Trends
    {% if enrollment_chart %}
    new Chart(document.getElementById('enrollmentChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: {{ enrollment_chart.labels|safe }},
            datasets: [{
                label: 'Enrollments',
                data: {{ enrollment_chart.data|safe }},
                borderColor: 'rgba(79, 70, 229, 1)',
                backgroundColor: 'rgba(79, 70, 229, 0.2)',
                fill: true,
                tension: 0.3
            }]
        },
        options: { responsive: true }
    });
    {% endif %}

    // Fee Trends
    {% if fee_chart %}
    new Chart(document.getElementById('feeChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ fee_chart.labels|safe }},
            datasets: [
                {
                    label: 'Collected',
                    data: {{ fee_chart.collected|safe }},
                    backgroundColor: 'rgba(16, 185, 129, 0.7)'
                },
                {
                    label: 'Pending',
                    data: {{ fee_chart.pending|safe }},
                    backgroundColor: 'rgba(239, 68, 68, 0.7)'
                }
            ]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
    {% endif %}

    // Top Courses
    {% if top_courses_chart %}
    new Chart(document.getElementById('topCoursesChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ top_courses_chart.labels|safe }},
            datasets: [{
                label: 'Enrollments',
                data: {{ top_courses_chart.data|safe }},
                backgroundColor: 'rgba(245, 158, 11, 0.7)'
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
    {% endif %}

    // Students per Course
    {% if students_per_course_chart %}
    new Chart(document.getElementById('studentsPerCourseChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: {{ students_per_course_chart.labels|safe }},
            datasets: [{
                label: 'Students',
                data: {{ students_per_course_chart.data|safe }},
                backgroundColor: [
                    '#ef4444', '#3b82f6', '#f59e0b', '#10b981', '#8b5cf6', '#f97316'
                ]
            }]
        },
        options: { responsive: true }
    });
    {% endif %}
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  $(document).ready(function() {
    $('.select2').select2({
      width: '100%',
      placeholder: function(){
        return $(this).data('placeholder');
      },
      allowClear: true,
      minimumResultsForSearch: 0 // Always show search
    });
  });
</script>
{% endblock %}
