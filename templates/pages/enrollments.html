{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Add Enrollment{% endblock %}

{% block extra_css %}
<style>
    .forms-sample label {
        color: #000000;
        font-weight: bold;
    }

    .forms-sample input::placeholder,
    .forms-sample select {
        color: #888888;
        font-style: italic;
    }

    .card {
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .readonly-input {
        background-color: #e9ecef;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <h3 class="page-title">Add Enrollment</h3>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#">Forms</a></li>
            <li class="breadcrumb-item active" aria-current="page">Add Enrollment</li>
        </ol>
    </nav>
</div>

{% if form.non_field_errors %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>Oops! Something went wrong.</strong>
    <ul class="mb-0">
        {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="row justify-content-center">
    <div class="col-md-8 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Enrollment Form</h4>
                <p class="card-description">Select student, batch, fee type, total batch fee and paid amount</p>

                <form class="forms-sample" method="post">
                    {% csrf_token %}

                    <div class="form-group">
                        <label for="student_field">Student</label>
                        {% if request.user.profile.role == 'student' %}
                        <input type="text" class="form-control readonly-input" value="{{ request.user.student.name }}" readonly>
                        <input type="hidden" name="student" value="{{ request.user.student.id }}">
                        {% else %}
                        {{ form.student|add_class:"form-control" }}
                        {% if form.student.errors %}
                        <div class="text-danger">{{ form.student.errors }}</div>
                        {% endif %}
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.batch.id_for_label }}">Batch</label>
                        {{ form.batch|add_class:"form-control" }}
                        {% if form.batch.errors %}
                        <div class="text-danger">{{ form.batch.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="id_batch_fee">Batch Fee (Total Course Fee)</label>
                        {% if request.user.profile.role == 'student' %}
                        <input type="number" id="id_batch_fee" class="form-control readonly-input" readonly>
                        {% else %}
                        <input type="number" id="id_batch_fee" name="fee_at_enrollment" class="form-control">
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.paid_amount.id_for_label }}">Paid Amount</label>
                        {% if request.user.profile.role == 'student' %}
                        <input type="number" id="id_paid_amount" name="paid_amount" class="form-control readonly-input" readonly>
                        {% else %}
                        {{ form.paid_amount|add_class:"form-control" }}
                        {% if form.paid_amount.errors %}
                        <div class="text-danger">{{ form.paid_amount.errors }}</div>
                        {% endif %}
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.fee_type.id_for_label }}">Fee Type</label>
                        {% if request.user.profile.role == 'student' %}
                        <input type="text" class="form-control readonly-input" value="One-time" readonly>
                        <input type="hidden" name="fee_type" value="one-time">
                        {% else %}
                        {{ form.fee_type|add_class:"form-control" }}
                        {% if form.fee_type.errors %}
                        <div class="text-danger">{{ form.fee_type.errors }}</div>
                        {% endif %}
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.status.id_for_label }}">Status</label>
                        {% if request.user.profile.role == 'student' %}
                        <input type="text" class="form-control readonly-input" value="enrolled" readonly>
                        <input type="hidden" name="status" value="enrolled">
                        {% else %}
                        {{ form.status|add_class:"form-control" }}
                        {% if form.status.errors %}
                        <div class="text-danger">{{ form.status.errors }}</div>
                        {% endif %}
                        {% endif %}
                    </div>

                    <button type="submit" class="btn btn-primary mr-2">Save</button>
                    <a href="{% url 'dashboard' %}" class="btn btn-light">Back to list</a>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function () {
    const batchSelect = $("#id_batch");
    const batchFeeInput = $("#id_batch_fee");
    const paidInput = $("#id_paid_amount");

    function updateFee() {
        const batchId = batchSelect.val();
        if (!batchId) {
            batchFeeInput.val("");
            paidInput.val("");
            return;
        }

        const url = "{% url 'batch_fee' 0 %}".replace("0", batchId);
        $.ajax({
            url: url,
            type: "GET",
            dataType: "json",
            success: function (data) {
                if (data.fee !== undefined) {
                    // Update total batch fee
                    batchFeeInput.val(data.fee);

                    // For students, prefill paid amount as total fee
                    if (paidInput.hasClass("readonly-input")) {
                        paidInput.val(data.fee);
                    }
                }
            },
            error: function () {
                batchFeeInput.val("");
                paidInput.val("");
            }
        });
    }

    updateFee();
    batchSelect.on("change", updateFee);
});
</script>
{% endblock %}
