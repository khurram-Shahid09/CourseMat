{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Add Enrollment{% endblock %}

{% block extra_css %}
<style>
  .forms-sample label {
    color: #000000ff;
    font-weight: bold;
  }
  .forms-sample input::placeholder,
  .forms-sample select {
    color: #888888;
    font-style: italic;
  }
  .card {
    padding: 20px;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <h3 class="page-title">Add Enrollment</h3>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Forms</a></li>
      <li class="breadcrumb-item active" aria-current="page">Add Enrollment</li>
    </ol>
  </nav>
</div>

{% if form.non_field_errors %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>Oops! Something went wrong.</strong>
    <ul class="mb-0">
        {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="row justify-content-center">
  <div class="col-md-8 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Enrollment Form</h4>
        <p class="card-description">Select student, course, and status</p>

        <form class="forms-sample" method="post">
          {% csrf_token %}

          <div class="form-group">
            <label for="student_field">Student</label>
            {% if request.user.profile.role == 'student' %}
              <input type="text" class="form-control" value="{{ request.user.student.name }}" readonly>
              <input type="hidden" name="student" value="{{ request.user.student.id }}">
            {% else %}
              {{ form.student|add_class:"form-control" }}
              {% if form.student.errors %}
                <div class="text-danger">{{ form.student.errors }}</div>
              {% endif %}
            {% endif %}
          </div>

          <div class="form-group">
            <label for="{{ form.course.id_for_label }}">Course</label>
            {{ form.course|add_class:"form-control" }}
            {% if form.course.errors %}
              <div class="text-danger">{{ form.course.errors }}</div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label for="{{ form.fee_at_enrollment.id_for_label }}">Fee</label>
            {% if request.user.profile.role == 'student' %}
              <input type="number" id="id_fee_at_enrollment" name="fee_at_enrollment" class="form-control" readonly>
            {% else %}
              {{ form.fee_at_enrollment|add_class:"form-control" }}
            {% endif %}
          </div>

          <div class="form-group">
            <label for="{{ form.start_date.id_for_label }}">Start Date</label>
            {{ form.start_date|add_class:"form-control"|attr:"type:date" }}
            {% if form.start_date.errors %}
              <div class="text-danger">{{ form.start_date.errors }}</div>
            {% endif %}
          </div>

          <div class="form-group">
            <label for="{{ form.status.id_for_label }}">Status</label>
            {% if request.user.profile.role == 'student' %}
              <input type="text" class="form-control" value="enrolled" readonly>
              <input type="hidden" name="status" value="enrolled">
            {% else %}
              {{ form.status|add_class:"form-control" }}
              {% if form.status.errors %}
                <div class="text-danger">{{ form.status.errors }}</div>
              {% endif %}
            {% endif %}
          </div>

          <button type="submit" class="btn btn-primary mr-2">Save</button>
          <a href="{% url 'dashboard' %}" class="btn btn-light">Back to list</a>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function () {
    const feeInput = $("#id_fee_at_enrollment");
    const courseSelect = $("#id_course");

    function updateFee() {
        const courseId = courseSelect.val();
        if (!courseId) {
            feeInput.val("");
            return;
        }
        const url = "{% url 'course-fee' 0 %}".replace("0", courseId);
        $.ajax({
            url: url,
            type: "GET",
            dataType: "json",
            success: function (data) {
                feeInput.val(data.fees !== null && data.fees !== undefined ? data.fees : "");
            },
            error: function () {
                feeInput.val("Error loading fee");
            },
        });
    }

    // Update fee on page load if course is pre-selected
    updateFee();

    // Update fee whenever course changes
    courseSelect.on("change", updateFee);
});
</script>
{% endblock %}
